from airflow import DAG
from airflow.operators.python import PythonOperator
from datetime import datetime, timedelta
import pandas as pd
import psycopg2
import os

default_args = {
    "owner": "airflow",
    "start_date": datetime(2025, 1, 1),
    "retries": 1,
    "retry_delay": timedelta(minutes=5),
}

def extract(**context):
    config = {{ sourceConfig }}
    file_path = config["filePath"]
    ext = os.path.splitext(file_path)[1]

    if ext == ".csv":
        df = pd.read_csv(file_path)
    elif ext == ".json":
        df = pd.read_json(file_path)
    elif ext == ".parquet":
        df = pd.read_parquet(file_path)
    else:
        raise ValueError(f"Unsupported file type: {ext}")

    return df.to_dict(orient="records")

def transform(**context):
    data = context["ti"].xcom_pull(task_ids="extract")
    df = pd.DataFrame(data)

    {% if feature_list %}
    df = df[{{ feature_list }}]
    {% endif %}

    {% if cleaning_rules %}
    {% for rule in cleaning_rules %}
    df = df.query("{{ rule }}")
    {% endfor %}
    {% endif %}

    return df.to_dict(orient="records")

def load(**context):
    df = pd.DataFrame(context["ti"].xcom_pull(task_ids="transform"))
    dest = {{ destinationConfig }}
    conn = psycopg2.connect(
        host=dest["host"],
        user=dest["user"],
        password=dest["password"],
        dbname=dest["database"],
        port=dest.get("port", 5432)
    )
    cursor = conn.cursor()
    for _, row in df.iterrows():
        cols = ','.join(row.keys())
        vals = ','.join(['%s'] * len(row))
        sql = f"INSERT INTO {{ destination_table }} ({cols}) VALUES ({vals})"
        cursor.execute(sql, tuple(row.values()))
    conn.commit()
    conn.close()

with DAG(
    dag_id="{{ dag_id }}",
    default_args=default_args,
    schedule="{{ schedule }}",
    catchup=False,
    description="{{ description }}",
    is_paused_upon_creation=False,
) as dag:
    t1 = PythonOperator(task_id="extract", python_callable=extract)
    t2 = PythonOperator(task_id="transform", python_callable=transform)
    t3 = PythonOperator(task_id="load", python_callable=load)

    t1 >> t2 >> t3
