from prefect import flow
from prefect.server.schemas.schedules import CronSchedule
from ETLSchedular import etl_flow

from fastapi import FastAPI, Request

app = FastAPI()

@app.get("/")
def read_root():
    return 
{
    "Hello": "World"
}

@app.post("/create-etl-pipeline")
async def create_pipeline(request: Request):
    cfg = await request.json()

    deployment = etl_flow.deploy(
        name=cfg["pipelinename"],
        parameters={
            "pipelinename": cfg["pipelinename"],
            "endpoint": cfg["endpoint"],
            "input_features": cfg["input_features"],
            # "api_secret_key": cfg["api_secret_key"],
        },
        schedule=CronSchedule(cron=cfg["cron"]),
    )

    # Register the deployment with the Prefect API
    deployment.apply()
    
    return 
{
    "status": "scheduled"
}
